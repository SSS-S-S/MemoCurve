<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MemoCurve - 英文記憶</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --primary: #4f46e5;
            --text-main: #0f172a;
            --text-sub: #64748b;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                              linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
            /* Padding for bottom nav + safe area */
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Utilities */
        .hidden-view { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        input:focus, select:focus { 
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); 
            border-color: var(--primary);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            border-radius: 9999px;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
            width: auto;
            max-width: 90%;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-sub);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .nav-btn.active {
            background-color: var(--text-main);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 640px) {
            .bottom-nav {
                width: calc(100% - 32px);
                justify-content: space-between;
                padding: 0.5rem;
            }
            .nav-btn {
                padding: 0.75rem;
                justify-content: center;
                flex: 1;
            }
            .nav-btn span { display: none; }
            .nav-btn i { font-size: 1.25rem; }
            
            .mobile-input-adjust {
                font-size: 16px; /* Prevents iOS zoom */
            }
        }
    </style>
</head>
<body>

    <!-- Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm opacity-0 transition-opacity duration-300 px-4">
        <div id="modal-box" class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-all duration-300 border border-white/50">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-slate-900">Title</h3>
            <p id="modal-msg" class="text-slate-500 mb-6 text-sm leading-relaxed">Message...</p>
            <div id="modal-input-area" class="hidden mb-6">
                <input type="text" id="modal-input" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-medium text-slate-800 mobile-input-adjust" placeholder="">
            </div>
            <div class="flex gap-3 justify-end" id="modal-actions"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-5 py-3 rounded-full shadow-xl z-[200] transition-all duration-300 opacity-0 pointer-events-none translate-y-[-10px] flex items-center gap-3 font-medium text-sm">
        <i id="toast-icon" class="ph-fill ph-check-circle text-emerald-400"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <!-- Header -->
    <header class="px-6 pt-10 pb-4 max-w-3xl mx-auto">
        <div class="flex justify-between items-center">
            <!-- Pack Info -->
            <div class="cursor-pointer group select-none" onclick="switchTab('packs')">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Current Pack</div>
                <div class="flex items-center gap-2">
                    <h1 id="current-pack-name" class="text-2xl font-extrabold text-slate-900 tracking-tight leading-none group-hover:text-indigo-600 transition-colors">Default</h1>
                    <div class="bg-slate-100 rounded-full p-1 group-hover:bg-indigo-50 transition-colors">
                        <i class="ph-bold ph-caret-down text-slate-400 group-hover:text-indigo-600 text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="flex flex-col items-end select-none">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Words</div>
                <div class="flex items-center gap-2">
                    <span id="total-words-badge" class="text-xl font-bold text-slate-900 tabular-nums">0</span>
                    <span class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-sm shadow-emerald-200"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-xl mx-auto px-4 mt-2">
        
        <!-- VIEW: Review -->
        <section id="view-review" class="view-section fade-in">
            <div id="review-container"></div>
        </section>

        <!-- VIEW: Add -->
        <section id="view-add" class="view-section hidden-view fade-in">
            <div class="bg-white border border-slate-200 shadow-sm rounded-3xl p-6 md:p-8">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="ph-duotone ph-plus-circle text-indigo-500 text-xl"></i> 新增單字
                    </h2>
                    <div class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-md border border-slate-100 uppercase tracking-wider">Create Card</div>
                </div>
                
                <form id="add-form" onsubmit="handleAddWord(event)" class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">English Word</label>
                        <input type="text" id="input-english" required class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all text-xl font-bold text-slate-900 placeholder-slate-300 mobile-input-adjust" placeholder="e.g. Epiphany">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Parts of Speech (Multi-select)</label>
                        <div class="flex flex-wrap gap-2" id="pos-select-container"></div>
                        <input type="hidden" id="input-pos-hidden" required>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Definition (Chinese)</label>
                        <input type="text" id="input-chinese" required class="w-full px-4 py-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white outline-none transition-all text-base font-bold text-slate-900 placeholder-slate-300 mobile-input-adjust" placeholder="例如：頓悟">
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-base shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl active:scale-[0.98] transition-all flex justify-center items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Add to Pack
                    </button>
                </form>
            </div>
        </section>

        <!-- VIEW: List -->
        <section id="view-list" class="view-section hidden-view fade-in">
            <!-- Search -->
            <div class="sticky top-0 z-20 bg-[#f8fafc]/95 backdrop-blur-md pb-4 pt-2">
                <div class="relative group">
                    <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg group-focus-within:text-indigo-500 transition-colors"></i>
                    <input type="text" id="search-input" oninput="renderWordList()" placeholder="Search words..." class="w-full pl-11 pr-4 py-3 rounded-xl bg-white border border-slate-200 shadow-sm focus:border-indigo-500 outline-none font-medium text-slate-700 mobile-input-adjust">
                </div>
            </div>

            <!-- List -->
            <div id="word-list-container" class="space-y-3 pb-24"></div>
            
            <div id="empty-list-msg" class="hidden py-20 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                     <i class="ph-duotone ph-magnifying-glass text-3xl"></i>
                </div>
                <p class="text-slate-400 font-medium text-sm">No words found</p>
            </div>
        </section>

        <!-- VIEW: Packs -->
        <section id="view-packs" class="view-section hidden-view fade-in space-y-6 pb-24">
            
            <div class="bg-white border border-slate-200 shadow-sm rounded-3xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph-duotone ph-files text-indigo-500"></i> My Packs</h3>
                    <button onclick="promptCreatePack()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold hover:bg-indigo-100 transition flex items-center gap-1">
                        <i class="ph-bold ph-plus"></i> New
                    </button>
                </div>
                <div id="packs-list" class="space-y-3 max-h-80 overflow-y-auto custom-scroll"></div>
            </div>

            <div class="bg-white border border-slate-200 shadow-sm rounded-3xl p-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Pack Settings</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportCurrentPack()" class="p-4 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition text-left group">
                        <i class="ph-duotone ph-export text-xl text-slate-400 mb-2 group-hover:text-indigo-500"></i>
                        <div class="font-bold text-sm text-slate-700 group-hover:text-indigo-700">Backup</div>
                    </button>
                    <button onclick="promptRenamePack()" class="p-4 bg-slate-50 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition text-left group">
                        <i class="ph-duotone ph-pencil-simple text-xl text-slate-400 mb-2 group-hover:text-indigo-500"></i>
                        <div class="font-bold text-sm text-slate-700 group-hover:text-indigo-700">Rename</div>
                    </button>
                    <button onclick="confirmResetPack()" class="p-4 bg-slate-50 rounded-xl hover:bg-orange-50 hover:text-orange-600 transition text-left group">
                        <i class="ph-duotone ph-arrow-counter-clockwise text-xl text-slate-400 mb-2 group-hover:text-orange-500"></i>
                        <div class="font-bold text-sm text-slate-700 group-hover:text-orange-700">Reset</div>
                    </button>
                    <button onclick="confirmDeletePack()" class="p-4 bg-slate-50 rounded-xl hover:bg-red-50 hover:text-red-600 transition text-left group">
                        <i class="ph-duotone ph-trash text-xl text-slate-400 mb-2 group-hover:text-red-500"></i>
                        <div class="font-bold text-sm text-slate-700 group-hover:text-red-700">Delete</div>
                    </button>
                </div>
            </div>

            <label class="block w-full p-6 border-2 border-dashed border-slate-300 rounded-3xl text-center text-slate-400 font-bold hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 cursor-pointer transition">
                <div class="text-sm flex flex-col items-center gap-2">
                    <i class="ph-bold ph-upload-simple text-2xl"></i>
                    Import Pack (.json)
                </div>
                <input type="file" accept=".json" onchange="importData(event)" class="hidden">
            </label>

        </section>

    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <button onclick="switchTab('review')" id="btn-review" class="nav-btn active">
            <i class="ph-bold ph-cards"></i><span>Review</span>
        </button>
        <button onclick="switchTab('add')" id="btn-add" class="nav-btn">
            <i class="ph-bold ph-plus-circle"></i><span>Add</span>
        </button>
        <button onclick="switchTab('list')" id="btn-list" class="nav-btn">
            <i class="ph-bold ph-list-dashes"></i><span>List</span>
        </button>
        <button onclick="switchTab('packs')" id="btn-packs" class="nav-btn">
            <i class="ph-bold ph-gear"></i><span>Settings</span>
        </button>
    </nav>

    <!-- JavaScript Logic -->
    <script>
        // --- Data & Config ---
        const DB_KEY_V2 = 'memoCurveData_v2';
        const OLD_DB_KEY = 'memoCurveData_v1';
        
        const POS_OPTIONS = [
            { value: 'n.', label: 'n.' }, { value: 'v.', label: 'v.' }, 
            { value: 'adj.', label: 'adj.' }, { value: 'adv.', label: 'adv.' },
            { value: 'prep.', label: 'prep.' }, { value: 'conj.', label: 'conj.' },
            { value: 'phrase', label: 'phrase' }, { value: 'other', label: 'other' }
        ];

        let appState = { activePackId: null, packs: [] };
        
        // Session State
        let reviewQueue = [];
        let currentIndex = 0;
        let quizMode = 'input'; 
        let feedbackState = null; // null, 'correct', 'incorrect'
        let currentChoices = [];
        let selectedPos = new Set();
        
        // Mode Flags
        let isRandomMode = false;   
        let isPracticeMode = false; 

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            refreshUI();
            renderPosSelection();
            document.addEventListener('keydown', handleGlobalKeydown);
            document.getElementById('view-review').classList.add('fade-in');
        });

        // --- Keyboard ---
        function handleGlobalKeydown(e) {
            if (e.target.tagName === 'INPUT') return;
            switch(e.key) {
                case '1': switchTab('review'); break;
                case '2': switchTab('add'); break;
                case '3': switchTab('list'); break;
                case '4': switchTab('packs'); break;
                case ' ': 
                    if (!document.getElementById('view-review').classList.contains('hidden-view') && feedbackState === 'incorrect') {
                        e.preventDefault();
                        const word = reviewQueue[currentIndex];
                        if(word) speak(word.english);
                    }
                    break;
            }
        }

        // --- Data Persistence (With SM-2 Migration) ---
        function loadData() {
            const savedV2 = localStorage.getItem(DB_KEY_V2);
            if (savedV2) {
                try {
                    appState = JSON.parse(savedV2);
                    appState.packs.forEach(pack => {
                        pack.words.forEach(w => { 
                            // Migration for Multi-POS
                            if (!Array.isArray(w.pos)) w.pos = [w.pos];
                            // Migration for SM-2
                            if (w.ef === undefined) w.ef = 2.5;
                            if (w.interval === undefined) w.interval = 0;
                            if (w.repetitions === undefined) w.repetitions = 0;
                        });
                    });
                } catch (e) { resetToDefault(); }
            } else {
                resetToDefault(); 
            }
            if (!appState.packs.find(p => p.id === appState.activePackId)) {
                appState.activePackId = appState.packs.length > 0 ? appState.packs[0].id : (resetToDefault() || appState.activePackId);
            }
        }

        function resetToDefault() {
            const id = generateId();
            appState = { activePackId: id, packs: [{ id: id, name: 'Default Pack', words: [] }] };
            saveData();
            return id;
        }

        function saveData() { 
            localStorage.setItem(DB_KEY_V2, JSON.stringify(appState)); 
            refreshUI(); 
        }

        function getCurrentPack() { return appState.packs.find(p => p.id === appState.activePackId) || appState.packs[0]; }
        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function refreshUI() {
            const pack = getCurrentPack();
            document.getElementById('current-pack-name').textContent = pack.name;
            document.getElementById('total-words-badge').textContent = `${pack.words.length}`;
            const activeSection = document.querySelector('.view-section:not(.hidden-view)');
            if (activeSection && activeSection.id === 'view-packs') renderPacksList();
            if (activeSection && activeSection.id === 'view-list') renderWordList();
        }

        // --- SM-2 Algorithm Implementation ---
        
        function calculateSM2(card, quality) {
            // quality: 0-5 (Binary mapping: Correct=4, Incorrect=1)
            let { ef, repetitions, interval } = card;
            
            // Defaults if corrupt
            if (!ef) ef = 2.5;
            if (!repetitions) repetitions = 0;
            if (!interval) interval = 0;

            if (quality >= 3) {
                if (repetitions === 0) {
                    interval = 1;
                } else if (repetitions === 1) {
                    interval = 6;
                } else {
                    interval = Math.ceil(interval * ef);
                }
                repetitions += 1;
            } else {
                repetitions = 0;
                interval = 0; // Lapse: Due immediately
            }

            // Update EF
            ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
            if (ef < 1.3) ef = 1.3;

            return { ef, repetitions, interval };
        }

        function startRandomSession() {
            const pack = getCurrentPack();
            if (pack.words.length === 0) {
                showToast("No words to shuffle", "error");
                return;
            }
            // Shuffle entire deck
            reviewQueue = [...pack.words].sort(() => Math.random() - 0.5);
            isRandomMode = true;
            isPracticeMode = false;
            currentIndex = 0;
            feedbackState = null;
            renderReview();
            showToast("Random Practice Started");
        }

        function initReviewSession() {
            const pack = getCurrentPack();
            if(pack.words.length === 0) {
                reviewQueue = [];
                return;
            }

            const now = Date.now();
            // Fetch due words
            let dueWords = pack.words.filter(w => w.nextReview <= now);
            
            if (dueWords.length > 0) {
                // Anki Style: Randomize review order to prevent serial position effect
                reviewQueue = dueWords.sort(() => Math.random() - 0.5);
                isRandomMode = false;
                isPracticeMode = false;
            } else {
                // Infinite Practice: If nothing due, load all sorted by urgency, but mark as practice
                reviewQueue = [...pack.words].sort((a, b) => a.nextReview - b.nextReview);
                isRandomMode = false;
                isPracticeMode = true; 
            }
            
            currentIndex = 0; 
            feedbackState = null;
        }

        function renderReview() {
            const container = document.getElementById('review-container');
            const pack = getCurrentPack();
            
            // Check if we need to start/refill queue
            if (!reviewQueue.length || currentIndex >= reviewQueue.length) {
                if (isRandomMode) {
                    container.innerHTML = getEmptyStateHTML("Random Session Done!", "Shuffle again to continue.");
                    return;
                } else {
                    initReviewSession();
                }
            }

            if (pack.words.length === 0) {
                container.innerHTML = getEmptyStateHTML("No words yet", "Add some words to start.");
                return;
            }

            renderReviewCard();
        }

        function getEmptyStateHTML(title, msg) {
            return `
                <div class="bg-white border border-slate-200 shadow-sm rounded-3xl p-10 text-center slide-up">
                    <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-400">
                        <i class="ph-duotone ph-student text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800">${title}</h3>
                    <p class="text-slate-500 mb-8 mt-2 text-sm">${msg}</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="switchTab('add')" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                            Create Card
                        </button>
                        ${isRandomMode ? `<button onclick="isRandomMode=false; renderReview()" class="text-slate-400 text-xs font-bold hover:text-slate-600">Back to Regular</button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderReviewCard() {
            const container = document.getElementById('review-container');
            const word = reviewQueue[currentIndex];
            const isError = feedbackState === 'incorrect';
            const isCorrect = feedbackState === 'correct';
            
            const progress = Math.min(((currentIndex) / reviewQueue.length) * 100, 100);

            let cardClass = 'bg-white border border-slate-200 shadow-lg';
            let animation = 'fade-in';
            if (isError) { cardClass = 'bg-white border-2 border-red-500 shadow-red-100'; animation = 'shake'; }
            if (isCorrect) { cardClass = 'bg-white border-2 border-emerald-500 shadow-emerald-100'; }
            
            const renderPosBadges = (posList) => {
                return posList.map(p => `<span class="inline-block px-2 py-1 bg-slate-100 text-slate-500 rounded text-[10px] font-bold uppercase tracking-wider mr-1.5 border border-slate-200">${p}</span>`).join('');
            };

            let statusBadge = '';
            let progressColor = 'bg-indigo-500';
            
            if (isRandomMode) {
                statusBadge = `<span class="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded flex items-center gap-1"><i class="ph-bold ph-shuffle"></i> Random</span>`;
                progressColor = 'bg-purple-500';
            } else if (isPracticeMode) {
                statusBadge = `<span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded flex items-center gap-1"><i class="ph-bold ph-infinity"></i> Practice</span>`;
                progressColor = 'bg-orange-500';
            } else {
                statusBadge = `<span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">Due: ${reviewQueue.length - currentIndex}</span>`;
            }

            let inputAreaHtml = '';
            if (quizMode === 'input') {
                inputAreaHtml = `
                    <div class="mt-6 relative">
                        <input type="text" id="answer-input" autocomplete="off" ${feedbackState ? 'disabled' : ''} 
                            onkeydown="if(event.key === 'Enter') handleInputSubmit()" 
                            placeholder="Type English..." 
                            class="w-full pl-5 pr-14 py-4 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 outline-none transition text-lg font-bold text-slate-900 placeholder-slate-400 mobile-input-adjust">
                        <button onclick="handleInputSubmit()" 
                            class="absolute right-2 top-2 bottom-2 aspect-square rounded-lg font-bold text-white transition-all shadow-sm flex items-center justify-center ${feedbackState ? 'bg-slate-800' : 'bg-indigo-600 hover:bg-indigo-700'}">
                            <i class="ph-bold ${feedbackState ? 'ph-arrow-right' : 'ph-paper-plane-right'} text-lg"></i>
                        </button>
                    </div>
                `;
            } else {
                if (!feedbackState) generateChoices(word);
                const buttonsHtml = currentChoices.map(choice => {
                    let btnStyle = "bg-white border border-slate-200 text-slate-600 hover:border-indigo-400 hover:text-indigo-600";
                    let icon = '<div class="w-5 h-5 rounded-full border-2 border-slate-200"></div>';
                    if (feedbackState) {
                        if (choice.id === word.id) { btnStyle = "bg-emerald-500 text-white border-emerald-600 shadow-md"; icon = '<i class="ph-bold ph-check-circle text-xl text-white"></i>'; }
                        else { btnStyle = "bg-slate-50 text-slate-300 border-slate-100 opacity-60"; }
                    }
                    return `<button onclick="handleChoiceSubmit('${choice.id}')" ${feedbackState ? 'disabled' : ''} class="w-full p-4 rounded-xl font-bold text-base text-left transition-all mb-2 flex items-center justify-between ${btnStyle}"><span>${choice.english}</span>${icon}</button>`;
                }).join('');
                inputAreaHtml = `<div class="flex flex-col mt-4">${buttonsHtml} ${feedbackState ? `<button onclick="nextCard()" class="mt-3 w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2">Next <i class="ph-bold ph-arrow-right"></i></button>` : ''}</div>`;
            }

            container.innerHTML = `
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-end mb-2">
                         <div class="flex items-center gap-2">
                             ${statusBadge}
                             ${(!isRandomMode && !isPracticeMode) ? '<button onclick="startRandomSession()" class="text-xs font-bold text-slate-400 hover:text-purple-500 bg-slate-50 hover:bg-purple-50 px-2 py-1 rounded transition" title="Shuffle"><i class="ph-bold ph-shuffle"></i></button>' : ''}
                         </div>
                        <div class="flex bg-white rounded-lg p-1 border border-slate-200">
                            <button onclick="switchQuizMode('input')" class="px-3 py-1 rounded text-[10px] font-bold transition-all ${quizMode === 'input' ? 'bg-slate-800 text-white' : 'text-slate-400'}">Input</button>
                            <button onclick="switchQuizMode('choice')" class="px-3 py-1 rounded text-[10px] font-bold transition-all ${quizMode === 'choice' ? 'bg-slate-800 text-white' : 'text-slate-400'}">Choice</button>
                        </div>
                    </div>
                    <div class="h-1.5 w-full bg-slate-200 rounded-full mb-6 overflow-hidden">
                        <div class="h-full ${progressColor} transition-all duration-300" style="width: ${progress}%"></div>
                    </div>

                    <div class="rounded-3xl p-8 transition-all duration-200 ${cardClass} ${animation}">
                        <div class="text-center min-h-[180px] flex flex-col justify-center items-center">
                            <div class="mb-4">${renderPosBadges(word.pos)}</div>
                            <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-2">${word.chinese}</h2>
                            ${isError ? `<div class="mt-6 flex flex-col items-center animate-pulse"><div class="text-rose-500 font-extrabold text-2xl mb-2">${word.english}</div><button onclick="speak('${word.english}')" class="text-indigo-500 bg-indigo-50 p-2 rounded-full hover:bg-indigo-100"><i class="ph-fill ph-speaker-high text-xl"></i></button></div>` : ''}
                        </div>
                        <div class="pt-6 border-t border-slate-100 mt-4">${inputAreaHtml}</div>
                    </div>
                    ${isPracticeMode ? '<div class="text-center mt-4 text-xs font-bold text-orange-400 opacity-80">Practice Mode: Stats will not be updated.</div>' : ''}
                </div>
            `;
            if (quizMode === 'input' && !feedbackState && window.innerWidth > 768) {
                setTimeout(() => document.getElementById('answer-input')?.focus(), 100);
            }
        }

        function generateChoices(correctWord) {
            const pack = getCurrentPack();
            let potential = pack.words.filter(w => w.id !== correctWord.id);
            // Fallback for choices
            if (potential.length === 0) {
                currentChoices = [correctWord]; // Just 1 option if no distractors
                return;
            }
            const distractors = potential.sort(() => 0.5 - Math.random()).slice(0, 3);
            currentChoices = [...distractors, correctWord].sort(() => 0.5 - Math.random());
        }

        function handleInputSubmit() {
            if (feedbackState) return nextCard();
            const inputEl = document.getElementById('answer-input');
            if (!inputEl) return;
            const input = inputEl.value.trim().toLowerCase();
            const target = reviewQueue[currentIndex].english.trim().toLowerCase();
            processResult(input === target);
        }

        function handleChoiceSubmit(selectedId) {
            if (feedbackState) return;
            processResult(selectedId === reviewQueue[currentIndex].id);
        }

        function processResult(isCorrect) {
            const word = reviewQueue[currentIndex];
            
            // SM-2 Update Logic
            // Only update real stats if we are in 'Due' mode, not Random or Practice
            if (!isRandomMode && !isPracticeMode) {
                // Map Binary to SM-2 Quality: 4=Correct, 1=Incorrect
                const quality = isCorrect ? 4 : 1;
                const newStats = calculateSM2(word, quality);
                
                // Update Word
                word.ef = newStats.ef;
                word.repetitions = newStats.repetitions;
                word.interval = newStats.interval;
                
                // Calculate next review time (Interval is in days)
                // If interval is 0 (wrong), set to NOW so it stays Due
                // If interval > 0, set to future
                if (newStats.interval === 0) {
                    word.nextReview = Date.now(); // Due immediately (Lapse)
                } else {
                    word.nextReview = Date.now() + (newStats.interval * 24 * 60 * 60 * 1000);
                }
                
                // Anki Behavior: If Wrong, Re-queue in current session
                if (!isCorrect) {
                    // Push to end of current queue to review again TODAY
                    // Use a clone or reference? Reference is fine as index moves
                    reviewQueue.push(word);
                }
                
                saveData();
            }

            feedbackState = isCorrect ? 'correct' : 'incorrect';
            renderReviewCard();
            if (isCorrect) setTimeout(nextCard, 800);
            else if(navigator.vibrate) navigator.vibrate(200);
        }

        function nextCard() {
            currentIndex++;
            feedbackState = null;
            renderReview();
        }

        function speak(text) {
            const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u);
        }

        function switchQuizMode(mode) {
            quizMode = mode;
            renderReviewCard();
        }

        // --- Common Helpers ---
        function renderWordList() {
            const container = document.getElementById('word-list-container');
            const term = document.getElementById('search-input').value.toLowerCase();
            const pack = getCurrentPack();
            const filtered = pack.words.filter(w => w.english.toLowerCase().includes(term) || w.chinese.includes(term));
            
            document.getElementById('empty-list-msg').className = filtered.length ? 'hidden' : 'block py-20 text-center';
            
            container.innerHTML = filtered.map(w => `
                <div class="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center group hover:border-indigo-300 transition-colors shadow-sm">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-slate-900 text-lg">${w.english}</span>
                            <span class="text-[10px] bg-emerald-50 text-emerald-600 px-1.5 rounded font-bold">Int: ${w.interval}d</span>
                        </div>
                        <div class="text-slate-600 text-sm mb-1.5">${w.chinese}</div>
                        <div>${w.pos.map(p => `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 border border-slate-200 px-1.5 py-0.5 rounded uppercase tracking-wide mr-1">${p}</span>`).join('')}</div>
                    </div>
                    <button onclick="confirmDeleteWord('${w.id}')" class="w-10 h-10 flex items-center justify-center text-slate-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition">
                        <i class="ph-bold ph-trash text-lg"></i>
                    </button>
                </div>
            `).join('');
        }

        // ... (Keep existing Add/Pack/Import/Export logic same as before, omitted for brevity but assumed present in full file) ...
        
        function renderPosSelection() {
            const container = document.getElementById('pos-select-container');
            container.innerHTML = POS_OPTIONS.map(opt => `
                <button type="button" onclick="togglePos('${opt.value}')" class="px-3 py-2 rounded-lg border text-sm font-bold transition-all ${selectedPos.has(opt.value) ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105' : 'bg-white border-slate-200 text-slate-500 hover:border-indigo-300'}">${opt.label}</button>
            `).join('');
            document.getElementById('input-pos-hidden').value = selectedPos.size > 0 ? 'valid' : '';
        }
        function togglePos(value) { if (selectedPos.has(value)) selectedPos.delete(value); else selectedPos.add(value); renderPosSelection(); }
        function handleAddWord(e) {
            e.preventDefault();
            const pack = getCurrentPack();
            const english = document.getElementById('input-english').value.trim();
            const chinese = document.getElementById('input-chinese').value.trim();
            if (selectedPos.size === 0) { showToast('Select at least one POS', 'error'); return; }
            if (!english || !chinese) return;
            pack.words.unshift({ id: generateId(), english, chinese, pos: Array.from(selectedPos), ef: 2.5, interval: 0, repetitions: 0, nextReview: Date.now(), createdAt: Date.now() });
            saveData();
            document.getElementById('add-form').reset();
            selectedPos.clear();
            renderPosSelection();
            if(window.innerWidth > 768) document.getElementById('input-english').focus();
            showToast('Word Added');
        }
        function confirmDeleteWord(id) { Modal.confirm('Delete', 'Delete this word?', () => { const pack = getCurrentPack(); pack.words = pack.words.filter(w => w.id !== id); saveData(); renderWordList(); showToast('Deleted'); }, 'danger'); }
        function renderPacksList() {
            const list = document.getElementById('packs-list');
            list.innerHTML = appState.packs.map(p => `<div onclick="switchPack('${p.id}')" class="flex items-center justify-between p-4 rounded-xl border cursor-pointer transition-all ${p.id === appState.activePackId ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100 hover:border-indigo-200'}"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${p.id === appState.activePackId ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}"><i class="ph-bold ${p.id === appState.activePackId ? 'ph-student' : 'ph-book'} text-lg"></i></div><div><div class="font-bold text-slate-800 text-sm">${p.name}</div><div class="text-xs font-bold text-slate-400 mt-0.5">${p.words.length} words</div></div></div>${p.id === appState.activePackId ? '<i class="ph-fill ph-check-circle text-indigo-600 text-xl"></i>' : ''}</div>`).join('');
        }
        function switchPack(id) { if (appState.activePackId === id) return; appState.activePackId = id; saveData(); reviewQueue = []; currentIndex = 0; isRandomMode = false; isPracticeMode = false; if (!document.getElementById('view-review').classList.contains('hidden-view')) renderReview(); showToast(`Switched to ${getCurrentPack().name}`); }
        function promptCreatePack() { Modal.prompt('New Pack', 'Enter name:', (name) => { if (!name.trim()) return; const newId = generateId(); appState.packs.push({ id: newId, name: name.trim(), words: [] }); appState.activePackId = newId; saveData(); showToast('Created'); }); }
        function promptRenamePack() { const pack = getCurrentPack(); Modal.prompt('Rename', 'New name:', (name) => { if (!name.trim()) return; pack.name = name.trim(); saveData(); showToast('Renamed'); }, pack.name); }
        function confirmDeletePack() { if (appState.packs.length <= 1) return Modal.alert('Error', 'Cannot delete last pack.'); const pack = getCurrentPack(); Modal.confirm('Delete', `Delete "${pack.name}"?`, () => { appState.packs = appState.packs.filter(p => p.id !== pack.id); appState.activePackId = appState.packs[0].id; saveData(); showToast('Deleted'); }, 'danger'); }
        function confirmResetPack() { const pack = getCurrentPack(); if(pack.words.length === 0) return; Modal.confirm('Reset', 'Reset progress?', () => { pack.words.forEach(w => { w.ef = 2.5; w.interval = 0; w.repetitions = 0; w.nextReview = Date.now(); }); saveData(); reviewQueue = []; showToast('Reset'); }, 'warning'); }
        function exportCurrentPack() { const pack = getCurrentPack(); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ type: "memo_pack", version: 1, data: pack })); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `memo_${pack.name}.json`); document.body.appendChild(dl); dl.click(); dl.remove(); showToast('Exported'); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); let newPack = null; if (Array.isArray(json)) { json.forEach(w => { if(!Array.isArray(w.pos)) w.pos = [w.pos]; }); newPack = { id: generateId(), name: `Import (${new Date().toLocaleDateString()})`, words: json }; } else if (json.type === "memo_pack" && json.data) { newPack = json.data; newPack.id = generateId(); newPack.name = `${newPack.name} (Imp)`; newPack.words.forEach(w => { if(!Array.isArray(w.pos)) w.pos = [w.pos]; }); } else throw new Error(); if (newPack) { appState.packs.push(newPack); appState.activePackId = newPack.id; saveData(); showToast('Imported'); } } catch { Modal.alert('Error', 'Invalid file'); } event.target.value = ''; }; reader.readAsText(file); }

        function switchTab(id) { document.querySelectorAll('.nav-btn').forEach(btn => { if(btn.id === `btn-${id}`) btn.classList.add('active'); else btn.classList.remove('active'); }); document.querySelectorAll('.view-section').forEach(el => { if(el.id === `view-${id}`) { el.classList.remove('hidden-view'); el.classList.add('fade-in'); } else { el.classList.add('hidden-view'); el.classList.remove('fade-in'); } }); if(id === 'review') renderReview(); if(id === 'list') renderWordList(); if(id === 'packs') renderPacksList(); }
        function showToast(msg, type = 'success') { const toast = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; document.getElementById('toast-icon').className = type==='error' ? 'ph-fill ph-warning-circle text-red-400' : 'ph-fill ph-check-circle text-emerald-400'; toast.classList.remove('opacity-0', 'translate-y-[-10px]'); setTimeout(() => toast.classList.add('opacity-0', 'translate-y-[-10px]'), 3000); }
        const Modal = { overlay: document.getElementById('modal-overlay'), box: document.getElementById('modal-box'), title: document.getElementById('modal-title'), msg: document.getElementById('modal-msg'), actions: document.getElementById('modal-actions'), inputArea: document.getElementById('modal-input-area'), input: document.getElementById('modal-input'), open(t, m, btns, showInput=false) { this.title.textContent = t; this.msg.textContent = m; this.actions.innerHTML = ''; this.inputArea.className = showInput ? 'block mb-6' : 'hidden'; if(showInput) { this.input.value = ''; setTimeout(() => this.input.focus(), 100); } btns.forEach(btn => { const b = document.createElement('button'); b.textContent = btn.text; b.className = `px-5 py-2.5 rounded-xl font-bold transition text-sm ${btn.class}`; b.onclick = () => { this.close(); if(btn.callback) showInput ? btn.callback(this.input.value) : btn.callback(); }; this.actions.appendChild(b); }); this.overlay.classList.remove('hidden'); requestAnimationFrame(() => { this.overlay.classList.remove('opacity-0'); this.box.classList.remove('scale-95'); this.box.classList.add('scale-100'); }); }, close() { this.overlay.classList.add('opacity-0'); this.box.classList.add('scale-95'); setTimeout(() => this.overlay.classList.add('hidden'), 300); }, alert(t, m) { this.open(t, m, [{ text: 'OK', class: 'bg-slate-900 text-white', callback: null }]); }, confirm(t, m, cb, type='normal') { this.open(t, m, [{ text: 'Cancel', class: 'bg-slate-100 text-slate-500' }, { text: 'Confirm', class: type==='danger'?'bg-red-500 text-white':'bg-indigo-600 text-white', callback: cb }]); }, prompt(t, m, cb, val='') { this.open(t, m, [{ text: 'Cancel', class: 'bg-slate-100 text-slate-500' }, { text: 'OK', class: 'bg-indigo-600 text-white', callback: cb }], true); if(val) this.input.value = val; } };
    </script>
</body>
</html>
